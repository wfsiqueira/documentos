Date: Tue, 4 Aug 2020 19:48:25 +0000 (UTC)
Message-ID: <1648188276.69.1596570505320@c8d122cc4352>
Subject: Exported From Confluence
MIME-Version: 1.0
Content-Type: multipart/related; 
	boundary="----=_Part_68_534606306.1596570505320"

------=_Part_68_534606306.1596570505320
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Content-Location: file:///C:/exported.html

<html xmlns:o=3D'urn:schemas-microsoft-com:office:office'
      xmlns:w=3D'urn:schemas-microsoft-com:office:word'
      xmlns:v=3D'urn:schemas-microsoft-com:vml'
      xmlns=3D'urn:w3-org-ns:HTML'>
<head>
    <meta http-equiv=3D"Content-Type" content=3D"text/html; charset=3Dutf-8=
">
    <title>Library - IAM</title>
    <!--[if gte mso 9]>
    <xml>
        <o:OfficeDocumentSettings>
            <o:TargetScreenSize>1024x640</o:TargetScreenSize>
            <o:PixelsPerInch>72</o:PixelsPerInch>
            <o:AllowPNG/>
        </o:OfficeDocumentSettings>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotOptimizeForBrowser/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
                <!--
        @page Section1 {
            size: 8.5in 11.0in;
            margin: 1.0in;
            mso-header-margin: .5in;
            mso-footer-margin: .5in;
            mso-paper-source: 0;
        }

        table {
            border: solid 1px;
            border-collapse: collapse;
        }

        table td, table th {
            border: solid 1px;
            padding: 5px;
        }

        td {
            page-break-inside: avoid;
        }

        tr {
            page-break-after: avoid;
        }

        div.Section1 {
            page: Section1;
        }

        /* Confluence print stylesheet. Common to all themes for print medi=
a */
/* Full of !important until we improve batching for print CSS */

@media print {
    #main {
        padding-bottom: 1em !important; /* The default padding of 6em is to=
o much for printouts */
    }

    body {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        font-size: 10pt;
        line-height: 1.2;
    }

    body, #full-height-container, #main, #page, #content, .has-personal-sid=
ebar #content {
        background: #fff !important;
        color: #000 !important;
        border: 0 !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
    }

    a, a:link, a:visited, a:focus, a:hover, a:active {
        color: #000;
    }

    #content h1,
    #content h2,
    #content h3,
    #content h4,
    #content h5,
    #content h6 {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        page-break-after: avoid;
    }

    pre {
        font-family: Monaco, "Courier New", monospace;
    }

    #header,
    .aui-header-inner,
    #navigation,
    #sidebar,
    .sidebar,
    #personal-info-sidebar,
    .ia-fixed-sidebar,
    .page-actions,
    .navmenu,
    .ajs-menu-bar,
    .noprint,
    .inline-control-link,
    .inline-control-link a,
    a.show-labels-editor,
    .global-comment-actions,
    .comment-actions,
    .quick-comment-container,
    #addcomment {
        display: none !important;
    }

    /* CONF-28544 cannot print multiple pages in IE */
    #splitter-content {
        position: relative !important;
    }

    .comment .date::before {
        content: none !important; /* remove middot for print view */
    }

    h1.pagetitle img {
        height: auto;
        width: auto;
    }

    .print-only {
        display: block;
    }

    #footer {
        position: relative !important; /* CONF-17506 Place the footer at en=
d of the content */
        margin: 0;
        padding: 0;
        background: none;
        clear: both;
    }

    #poweredby {
        border-top: none;
        background: none;
    }

    #poweredby li.print-only {
        display: list-item;
        font-style: italic;
    }

    #poweredby li.noprint {
        display: none;
    }

    /* no width controls in print */
    .wiki-content .table-wrap,
    .wiki-content p,
    .panel .codeContent,
    .panel .codeContent pre,
    .image-wrap {
        overflow: visible !important;
    }

    /* TODO - should this work? */
    #children-section,
    #comments-section .comment,
    #comments-section .comment .comment-body,
    #comments-section .comment .comment-content,
    #comments-section .comment p {
        page-break-inside: avoid;
    }

    #page-children a {
        text-decoration: none;
    }

    /**
     hide twixies

     the specificity here is a hack because print styles
     are getting loaded before the base styles. */
    #comments-section.pageSection .section-header,
    #comments-section.pageSection .section-title,
    #children-section.pageSection .section-header,
    #children-section.pageSection .section-title,
    .children-show-hide {
        padding-left: 0;
        margin-left: 0;
    }

    .children-show-hide.icon {
        display: none;
    }

    /* personal sidebar */
    .has-personal-sidebar #content {
        margin-right: 0px;
    }

    .has-personal-sidebar #content .pageSection {
        margin-right: 0px;
    }

    .no-print, .no-print * {
        display: none !important;
    }
}
-->
    </style>
</head>
<body>
    <h1>Library - IAM</h1>
    <div class=3D"Section1">
        <p>O<span>&nbsp;</span><strong>Zup IAM</strong><span>&nbsp;</span>=
=C3=A9 respons=C3=A1vel por disponibilizar o processo de IAM (<em>Identity =
and Access Management</em>) para os sistemas que utilizam Spring Boot. As c=
onfigura=C3=A7=C3=B5es de autoriza=C3=A7=C3=A3o, autentica=C3=A7=C3=A3o e r=
ecursos s=C3=A3o realizadas no<span>&nbsp;</span><strong>Keycloak</strong>.=
 Esta biblioteca tem o objetivo de facilitar a integra=C3=A7=C3=A3o e padro=
nizar o IAM da Zup.</p>
<p>A biblioteca&nbsp;<strong>Zup IAM</strong> tamb=C3=A9m =C3=A9 a respons=
=C3=A1vel pela sincroniza=C3=A7=C3=A3o das&nbsp;<strong>roles</strong> e da=
s&nbsp;<strong>depend=C3=AAncias entre m=C3=B3dulos</strong>, bem como pelo=
&nbsp;<strong>service discovery</strong> do&nbsp;<strong>secret</strong> do=
 m=C3=B3dulo do seu projeto e os dados de comunica=C3=A7=C3=A3o com o&nbsp;=
<strong>Keycloak</strong>. Todo esse processo de sincronia =C3=A9 realizado=
 atrav=C3=A9s de&nbsp;<strong>gRPC</strong>.</p>
<p>Para facilitar o uso, est=C3=A1 dispon=C3=ADvel na pasta<span>&nbsp;</sp=
an><em>samples</em><span>&nbsp;</span>exemplos de projetos utilizando esta =
biblioteca.</p>
<p>Al=C3=A9m de disponibilizar o processo de IAM da pr=C3=B3pria aplica=C3=
=A7=C3=A3o, tamb=C3=A9m est=C3=A1 dispon=C3=ADvel a integra=C3=A7=C3=A3o en=
tre aplica=C3=A7=C3=B5es utilizando<span>&nbsp;</span><em>Feign</em>.</p>
<h2 id=3D"Library-IAM-1.Instala=C3=A7=C3=A3o">1. Instala=C3=A7=C3=A3o</h2>
<p><span style=3D"color: rgb(36,41,46);">Para instalar a biblioteca =C3=A9 =
preciso realizar a adi=C3=A7=C3=A3o do(s) reposit=C3=B3rio(s) da zup na con=
figura=C3=A7=C3=A3o do maven do projeto. Estes reposit=C3=B3rios s=C3=A3o c=
olocados a seguir:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Reposit=C3=B3rios da Zup</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">&lt;repo=
sitories&gt;
    &lt;repository&gt;
        &lt;id&gt;internal-zup&lt;/id&gt;
        &lt;name&gt;Internal Release Repository&lt;/name&gt;
        &lt;url&gt;http://archiva.aws.zup.com.br/repository/internal&lt;/ur=
l&gt;
        &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;/releases&gt;
        &lt;snapshots&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
        &lt;/snapshots&gt;
    &lt;/repository&gt;

    &lt;repository&gt;
        &lt;id&gt;snapshots-zup&lt;/id&gt;
        &lt;name&gt;Internal Snapshot Repository&lt;/name&gt;
        &lt;url&gt;http://archiva.aws.zup.com.br/repository/snapshots&lt;/u=
rl&gt;
        &lt;releases&gt;
            &lt;enabled&gt;false&lt;/enabled&gt;
        &lt;/releases&gt;
        &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;/snapshots&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;</pre>=20
</div>
</div>
<p><span style=3D"color: rgb(36,41,46);">Ap=C3=B3s os reposit=C3=B3rios =C3=
=A9 preciso realizar a adi=C3=A7=C3=A3o da depend=C3=AAncia da biblioteca. =
Para isso =C3=A9 preciso apenas adicionar a depend=C3=AAncia mostrada abaix=
o:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Depend=C3=AAncias da IAM</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">&lt;depe=
ndency&gt;
    &lt;groupId&gt;br.com.zup&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-zup-iam&lt;/artifactId&gt;
    &lt;version&gt;last.version&lt;/version&gt;
&lt;/dependency&gt;</pre>=20
</div>
</div>
<p class=3D"auto-cursor-target"><span style=3D"color: rgb(36,41,46);">Al=C3=
=A9m desta bilioteca, est=C3=A1 dispon=C3=ADvel a integra=C3=A7=C3=A3o com =
o Feign como cliente. Para isso existe uma depend=C3=AAncia especifica, sen=
do mostrada a seguir:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Depend=C3=AAncias da IAM</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">&lt;depe=
ndency&gt;
    &lt;groupId&gt;br.com.zup&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-zup-iam-feign&lt;/artifactId&gt;
    &lt;version&gt;last.version&lt;/version&gt;
&lt;/dependency&gt;</pre>=20
</div>
</div>
<p>Verifique as =C3=BAltimas vers=C3=B5es dispon=C3=ADveis no Archiva:<a hr=
ef=3D"http://archiva.aws.zup.com.br/#artifact/br.com.zup/spring-boot-starte=
r-zup-iam" class=3D"external-link" rel=3D"nofollow">http://archiva.aws.zup.=
com.br/#artifact/br.com.zup/spring-boot-starter-zup-iam</a><span>&nbsp;</sp=
an>e<span>&nbsp;</span><a href=3D"http://archiva.aws.zup.com.br/#artifact/b=
r.com.zup/spring-boot-starter-zup-iam-feign" class=3D"external-link" rel=3D=
"nofollow">http://archiva.aws.zup.com.br/#artifact/br.com.zup/spring-boot-s=
tarter-zup-iam-feign</a></p>
<p>Ap=C3=B3s a adi=C3=A7=C3=A3o do reposit=C3=B3rio e da depend=C3=AAncia a=
 biblioteca j=C3=A1 deve estar instalada. O pr=C3=B3ximo passo consiste na =
configura=C3=A7=C3=A3o da biblioteca.</p>
<h3 id=3D"Library-IAM-1.1.Instala=C3=A7=C3=A3oemconjuntocomospringcloudcons=
uldiscovery">1.1. Instala=C3=A7=C3=A3o em conjunto com o spring cloud consu=
l discovery</h3>
<p>A lib do <strong>consul discovery</strong> for=C3=A7a uma vers=C3=A3o do=
 <strong>netty.io</strong> que n=C3=A3o =C3=A9 compat=C3=ADvel com o gRPC p=
ois este utiliza o protocolo <strong>http2</strong> para comunica=C3=A7=C3=
=A3o. A vers=C3=A3o correta para utilizar <strong>http2</strong> com o nett=
y =C3=A9 a vers=C3=A3o&nbsp;<strong>4.1</strong> ou superior. Caso esteja t=
endo conflito com a vers=C3=A3o que =C3=A9 fornecida pelo spring cloud cons=
ul discovery, coloque a seguinte exclus=C3=A3o:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>pom.xml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">    &lt;=
dependencyManagement&gt;
        &lt;dependencies&gt;
           =20
            &lt;!-- Suas depend=C3=AAncias j=C3=A1 existentes --&gt;

            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;=
/artifactId&gt;
                &lt;version&gt;1.3.0.RELEASE&lt;/version&gt;
                &lt;exclusions&gt;
                    &lt;exclusion&gt;
                        &lt;groupId&gt;io.netty&lt;/groupId&gt;
                        &lt;artifactId&gt;netty-codec-http&lt;/artifactId&g=
t;
                    &lt;/exclusion&gt;
                    &lt;exclusion&gt;
                        &lt;groupId&gt;io.netty&lt;/groupId&gt;
                        &lt;artifactId&gt;netty-codec&lt;/artifactId&gt;
                    &lt;/exclusion&gt;
                    &lt;exclusion&gt;
                        &lt;groupId&gt;io.netty&lt;/groupId&gt;
                        &lt;artifactId&gt;netty-transport-native-epoll&lt;/=
artifactId&gt;
                    &lt;/exclusion&gt;
                    &lt;exclusion&gt;
                        &lt;groupId&gt;io.netty&lt;/groupId&gt;
                        &lt;artifactId&gt;netty-common&lt;/artifactId&gt;
                    &lt;/exclusion&gt;
                    &lt;exclusion&gt;
                        &lt;groupId&gt;io.netty&lt;/groupId&gt;
                        &lt;artifactId&gt;netty-buffer&lt;/artifactId&gt;
                    &lt;/exclusion&gt;
                &lt;/exclusions&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;</pre>=20
</div>
</div>
<p><br></p>
<h2 id=3D"Library-IAM-2.Configura=C3=A7=C3=B5es">2. Configura=C3=A7=C3=B5es=
</h2>
<p>A configura=C3=A7=C3=A3o foi concebida para ser a mais simples e f=C3=A1=
cil poss=C3=ADvel. Esta biblioteca j=C3=A1 trabalha com os conceitos de<spa=
n>&nbsp;</span><strong>multi-tenancy</strong>. Ao adicionar a biblioteca em=
 seu projeto automaticamente j=C3=A1 s=C3=A3o carregadas as fun=C3=A7=C3=B5=
es do IAM.</p>
<p>Basicamente, s=C3=A3o necess=C3=A1rias duas configura=C3=A7=C3=B5es. A p=
rimeira consiste na configura=C3=A7=C3=A3o da biblioteca. A outra correspon=
de em definir quais s=C3=A3o as restri=C3=A7=C3=B5es de acesso de cada serv=
i=C3=A7o conforme uma ou mais<span>&nbsp;</span><em>roles</em>.</p>
<p>Esta biblioteca possui a depend=C3=AAncia do Spring Security. Por padr=
=C3=A3o, o Spring Security habilita a autentica=C3=A7=C3=A3o<span>&nbsp;</s=
pan><em>basic</em>, portanto, torna-se necess=C3=A1rio desabilitar a autent=
ica=C3=A7o<span>&nbsp;</span><em>basic</em><span>&nbsp;</span>setando a pro=
priedade<span>&nbsp;</span><em>security.basic.enabled=3Dfalse</em>. Como es=
ta biblioteca realiza automaticamente as configura=C3=A7=C3=B5es de seguran=
=C3=A7a, caso haja necessidade de desativar a seguran=C3=A7a, em cen=C3=A1r=
ios de teste por exemplo, =C3=A9 preciso declarar nas propriedades do sprin=
g as seguintes propriedades:</p>
<ul>
<li><strong>security.enabled</strong>=3Dfalse</li>
<li><strong>security.basic.enabled</strong>=3Dfalse</li>
</ul>
<h3 id=3D"Library-IAM-2.1.ConfigurandoaBiblioteca">2.1. Configurando a Bibl=
ioteca</h3>
<p>Para realizar a configura=C3=A7=C3=A3o =C3=A9 preciso apenas adicionar 3=
 arquivos na pasta<span>&nbsp;</span><em>resources</em>. As propriedades do=
 spring, geralmente configuradas no <em>application.properties</em> (ou <em=
>application.yml</em>), =C3=A9 respons=C3=A1vel por configurar o projeto pa=
ra se comunicar com o <strong>Keycloak</strong>&nbsp;(mais informa=C3=A7=C3=
=B5es dispon=C3=ADveis em<span>&nbsp;</span><a href=3D"http://www.keycloak.=
org/docs/3.3/securing_apps/topics/oidc/java/java-adapter-config.html" class=
=3D"external-link" rel=3D"nofollow">http://www.keycloak.org/docs/3.3/securi=
ng_apps/topics/oidc/java/java-adapter-config.html</a>):</p>
<ul>
<li><strong>keycloak.resource</strong>: nome do cliente configurado para a =
aplica=C3=A7=C3=A3o presente no Keycloak.</li>
<li><strong>keycloak.authServerUrl</strong>: URL que est=C3=A1 a aplica=C3=
=A7=C3=A3o do Keycloak. S=C3=B3 ser=C3=A1 utilizado se a propriedade&nbsp;<=
strong>security.sync</strong> for&nbsp;<em>false</em>.</li>
<li><strong>keycloak.bearerOnly</strong>: Por ser igual a<span>&nbsp;</span=
><em>true</em><span>&nbsp;</span>ou<span>&nbsp;</span><em>false</em><span>&=
nbsp;</span>e indica se ao receber uma requisi=C3=A7=C3=A3o n=C3=A3o autent=
icada se deve ocorrer o redirecionamento para a tela de login do Keycloak. =
Por padr=C3=A3o, este valor =C3=A9 true, uma vez que =C3=A9 responsabilidad=
e do<span>&nbsp;</span><em>front</em><span>&nbsp;</span>redirecionar para a=
 tela de login.</li>
<li><strong>keycloak.sslRequired</strong>: Existem as op=C3=A7=C3=B5es de<s=
pan>&nbsp;</span><em>all</em>,<span>&nbsp;</span><em>external</em><span>&nb=
sp;</span>e<span>&nbsp;</span><em>none</em>. Isto indica quais tipos de req=
uisi=C3=A7=C3=B5es em que HTTPS s=C3=A3o obrigat=C3=B3rias.<span>&nbsp;</sp=
an><em>all</em><span>&nbsp;</span>obriga que todas as requisi=C3=A7=C3=B5es=
 sejam com HTTPS.<span>&nbsp;</span><em>external</em><span>&nbsp;</span>faz=
 com que requisi=C3=A7=C3=B5es originadas de<span>&nbsp;</span><em>localhos=
t</em>,<span>&nbsp;</span><em>127.0.0.1</em>,<span>&nbsp;</span><em>10.0.x.=
x</em>,<span>&nbsp;</span><em>192.168.x.x</em><span>&nbsp;</span>e<span>&nb=
sp;</span><em>172..16.x.x</em>, sejam HTTPS.<span>&nbsp;</span><em>none</em=
><span>&nbsp;</span>indica que n=C3=A3o =C3=A9 preciso de HTTPS. Detalhes d=
ispon=C3=ADveis em<span>&nbsp;</span><a href=3D"http://www.keycloak.org/doc=
s/3.3/server_installation/topics/network/https.html" class=3D"external-link=
" rel=3D"nofollow">http://www.keycloak.org/docs/3.3/server_installation/top=
ics/network/https.html</a>.&nbsp;S=C3=B3 ser=C3=A1 utilizado se a proprieda=
de&nbsp;<strong>security.sync</strong> for&nbsp;<em>false</em>.</li>
<li><strong>keycloak.credentials.secret</strong>: Determina o secret usado =
para a autentica=C3=A7=C3=A3o entre aplica=C3=A7=C3=B5es. Este valor =C3=A9=
 configurado tamb=C3=A9m no keycloak para o dado<span>&nbsp;</span><strong>=
resource</strong>.&nbsp;S=C3=B3 ser=C3=A1 utilizado se a propriedade&nbsp;<=
strong>security.sync</strong> for&nbsp;<em>false</em>.</li>
<li><p><strong>security.enabled</strong>: Habilita ou desabilita a seguran=
=C3=A7a. Valor padr=C3=A3o =C3=A9<span>&nbsp;</span><em>true</em>.</p></li>
<li><strong>security.basic.enabled</strong>: Se colocado como<span>&nbsp;</=
span><em>false</em><span>&nbsp;</span>desabilita a autentica=C3=A7=C3=A3o B=
ASIC. Valor padr=C3=A3o =C3=A9<span>&nbsp;</span><em>true</em>.</li>
<li><strong>security.permitUnmappedResources</strong>: Se colocado como<spa=
n>&nbsp;</span><em>true</em>, requisi=C3=A7=C3=B5es n=C3=A3o mapeadas no ar=
quivo security-constraints.yml ter=C3=A3o acesso permitido. Valor padr=C3=
=A3o =C3=A9<span>&nbsp;</span><em>false</em>.</li>
<li><strong>security.tokenCompressionEnabled:</strong> Se colocado com&nbsp=
;<em>false</em> desabilita a compress=C3=A3o do token utilizado para autent=
ica=C3=A7=C3=A3o entre m=C3=B3dulos (feign). Valor padr=C3=A3o =C3=A9&nbsp;=
<em>true.</em></li>
<li><strong>security.realmSpecificModule:</strong> Se o m=C3=B3dulo for esp=
ec=C3=ADfico para uma determinada organiza=C3=A7=C3=A3o, um m=C3=B3dulo cus=
tomizado para ela e/ou um m=C3=B3dulo que s=C3=B3 exista nessa organiza=C3=
=A7=C3=A3o, definir esse valor como&nbsp;<em>true</em>. Valor padr=C3=A3o&n=
bsp;<em>false</em>.</li>
<li><strong>security.sync:</strong> Se colocado como&nbsp;<em>true</em> hab=
ilita a sincroniza=C3=A7=C3=A3o de m=C3=B3dulos e roles no projeto automati=
camente. Tamb=C3=A9m ativa o servi=C3=A7o de discovery para recuperar o&nbs=
p;<strong>secret</strong> do m=C3=B3dulo e os dados de conex=C3=A3o do keyc=
loak. Valor padr=C3=A3o =C3=A9&nbsp;<em>true</em>. (Para a sincroniza=C3=A7=
=C3=A3o funcionar, =C3=A9 necess=C3=A1rio que o projeto tenha como depend=
=C3=AAncia o zup-iam-adapters (Ver se=C3=A7=C3=A3o 2.5).</li>
<li><strong>security.grpc.iamSyncServerHost:</strong> Endere=C3=A7o do IAM =
que a aplica=C3=A7=C3=A3o utilizar=C3=A1 para sincronizar as roles, as depe=
nd=C3=AAncias e realizar o servi=C3=A7o de discovery dos dados do keycloak.=
</li>
<li><strong>security.grpc.iamSyncServerPort:</strong> Porta do&nbsp;<strong=
>iamSyncServerHost</strong> na qual o&nbsp;<em>gRPC</em> ir=C3=A1 se conect=
ar para realizar a sincronia dos dados.</li>
<li><strong>security.grpc.iamAuthSecret:</strong> C=C3=B3digo secreto usado=
 para autenticar entre o cliente e o servidor gRPC do realwave-iam.</li>
<li><strong>security.cors.enabled</strong>: Se colocado como<span>&nbsp;</s=
pan><em>true</em><span>&nbsp;</span>a aplica=C3=A7=C3=A3o habilita o CORS. =
Valor padr=C3=A3o =C3=A9<span>&nbsp;</span><em>false</em>.</li>
<li><strong>security.cors.maxAge</strong>: Se o CORS est=C3=A1 ativo este p=
ar=C3=A2metro determina o retorno do<span>&nbsp;</span><em>Access-Control-M=
ax-Age</em>.</li>
<li><strong>security.cors.allowedMethods</strong>: Se o CORS est=C3=A1 ativ=
o aqui =C3=A9 determinado quais s=C3=A3o os m=C3=A9todos aceitos.</li>
<li><strong>security.cors.allowedHeaders</strong>: Se o CORS est=C3=A1 ativ=
o aqui =C3=A9 determinado quais s=C3=A3o os headers aceitos.</li>
<li><strong>zup.iam.feign.cache-key</strong>: Nome do identificador utiliza=
do pelo Spring Cache Manager para armazenar os tokens do Keycloak.</li>
<li><strong>zup.iam.feign.revocation.enabled</strong>: Se colocado como <em=
>false</em> n=C3=A3o ir=C3=A1 exp=C3=B4r uma rota que possibilite a revoga=
=C3=A7=C3=A3o de todos os tokens, for=C3=A7ando a lib se autenticar novamen=
te no Keycloak. Efeito semelhante a resetar as sess=C3=B5es ativas.<br>A UR=
L exposta ser=C3=A1: <strong>DELETE http://your_application_url/zup/iam/fei=
gn/auth</strong> e retorna um http 204, indicando possibilidade de sucesso.=
 S=C3=B3 funciona na vers=C3=B5es do zup-iam superiores a <strong>2018R2.4.=
0</strong>.</li>
</ul>
<p>=C3=89 importante salientar que os<span>&nbsp;</span><em>origins</em><sp=
an>&nbsp;</span>do CORS s=C3=A3o configurados no<span>&nbsp;</span><em>Keyc=
loak</em>, logo n=C3=A3o =C3=A9 preciso que seja configurado na aplica=C3=
=A7=C3=A3o.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">security:
  enabled: true
  basic:
    enabled: false
  permitUnmappedResources: false
  tokenCompressionEnabled: true
  realmSpecificModule: false
  sync: true
  grpc:
    iamSyncServerHost: localhost
    iamSyncServerPort: 7073
    iamAuthSecret: iamverysecretive

  cors:
    enabled: true
    allowedHeaders: Authorization, X-Application-Id, X-Organization-Slug
    allowedMethods: GET, POST, PUT, DELETE

keycloak:
  authServerUrl: http://localhost:8080/auth
  realm: zup
  resource: resource name
  bearerOnly: true
  sslRequired: external
  credentials:
    secret: resource generated secret

zup:
  iam:
    feign:
      cacheKey: some-random-key
      revocation:
        enabled: true</pre>=20
</div>
</div>
<h3 id=3D"Library-IAM-2.2.ConfigurandoasConstraints">2.2. Configurando as<s=
pan>&nbsp;</span><em>Constraints</em></h3>
<p><span style=3D"color: rgb(36,41,46);">As<span>&nbsp;</span></span><em>co=
nstraints</em><span style=3D"color: rgb(36,41,46);"><span>&nbsp;</span>indi=
cam quais s=C3=A3o as<span>&nbsp;</span></span><em>roles</em><span style=3D=
"color: rgb(36,41,46);"><span>&nbsp;</span>necess=C3=A1rias para acessar os=
 recursos de sua aplica=C3=A7=C3=A3o. Esta configura=C3=A7=C3=A3o =C3=A9 re=
alizada no arquivo<span>&nbsp;</span></span><em>security-constraints.yml</e=
m><span style=3D"color: rgb(36,41,46);">, sendo colocado dentro dos<span>&n=
bsp;</span></span><em>resources</em><span style=3D"color: rgb(36,41,46);">.=
 =C3=89 poss=C3=ADvel deteminar 3 tipos de informa=C3=A7=C3=B5es, sendo<spa=
n>&nbsp;</span></span><em>patterns</em><span style=3D"color: rgb(36,41,46);=
">,<span>&nbsp;</span></span><em>roles</em><span style=3D"color: rgb(36,41,=
46);"><span>&nbsp;</span>e<span>&nbsp;</span></span><em>methods</em><span s=
tyle=3D"color: rgb(36,41,46);">. A seguir =C3=A9 colocado um exemplo de con=
figura=C3=A7=C3=A3o:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo de Restri=C3=A7=C3=B5es</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">constrain=
ts:
  - pattern: /api/role
    roles:
      zup-role: []

  - pattern: /api/module
    roles:
      zup-module-read:
        - GET
      zup-module-write:
        - POST
        - PUT
        - DELETE

  - pattern: /api/realms/{name}/applications
    roles:
      zup-application:
        - GET

publicConstraints:
  - pattern: /health-check
    methods:
      - GET</pre>=20
</div>
</div>
<p><span style=3D"color: rgb(36,41,46);">Neste exemplo, em <strong>constrai=
nts</strong>, existem 4<span>&nbsp;</span></span><em>roles</em><span style=
=3D"color: rgb(36,41,46);">, sendo a<span>&nbsp;</span></span><strong>zup-r=
ole</strong><span style=3D"color: rgb(36,41,46);">,<span>&nbsp;</span></spa=
n><strong>zup-module-read</strong><span style=3D"color: rgb(36,41,46);">,<s=
pan>&nbsp;</span></span><strong>zup-module-write</strong><span style=3D"col=
or: rgb(36,41,46);"><span>&nbsp;</span>e<span>&nbsp;</span></span><strong>z=
up-application</strong><span style=3D"color: rgb(36,41,46);">. Para acessar=
 qualquer recurso do caminho<span>&nbsp;</span></span><em>/api/role</em><sp=
an style=3D"color: rgb(36,41,46);"><span>&nbsp;</span>=C3=A9 preciso ter a<=
span>&nbsp;</span></span><em>role</em><span style=3D"color: rgb(36,41,46);"=
><span>&nbsp;</span></span><strong>zup-role</strong><span style=3D"color: r=
gb(36,41,46);">. J=C3=A1 o recurso do tipo<span>&nbsp;</span></span><em>GET=
</em><span style=3D"color: rgb(36,41,46);"><span>&nbsp;</span>de<span>&nbsp=
;</span></span><em>/api/module&nbsp;</em><span style=3D"color: rgb(36,41,46=
);">=C3=A9 necess=C3=A1ria a<span>&nbsp;</span></span><em>role</em><span st=
yle=3D"color: rgb(36,41,46);"><span>&nbsp;</span></span><strong>zup-module-=
read</strong><span style=3D"color: rgb(36,41,46);">. O recurso<span>&nbsp;<=
/span></span><em>/api/module</em><span style=3D"color: rgb(36,41,46);"><spa=
n>&nbsp;</span>dos tipos<span>&nbsp;</span></span><em>POST</em><span style=
=3D"color: rgb(36,41,46);">,<span>&nbsp;</span></span><em>PUT</em><span sty=
le=3D"color: rgb(36,41,46);"><span>&nbsp;</span>e<span>&nbsp;</span></span>=
<em>DELETE</em><span style=3D"color: rgb(36,41,46);">, necessita da role<sp=
an>&nbsp;</span></span><strong>zup-module-write</strong><span style=3D"colo=
r: rgb(36,41,46);">. Finalmente, para acessar<span>&nbsp;</span></span><em>=
/api/realms/{name:[a-z-]+}/applications</em><span style=3D"color: rgb(36,41=
,46);"><span>&nbsp;</span>=C3=A9 preciso de ter a<span>&nbsp;</span></span>=
<em>role</em><span style=3D"color: rgb(36,41,46);"><span>&nbsp;</span></spa=
n><em>zup-application</em><span style=3D"color: rgb(36,41,46);">. =C3=89 in=
teressante que nos caminhos =C3=A9&nbsp;poss=C3=ADvel utilizar regex, tal c=
omo o exemplo<span>&nbsp;</span></span><em>/api/realms/{name:[a-z-]+}/appli=
cations</em><span style=3D"color: rgb(36,41,46);">.</span></p>
<p><span style=3D"color: rgb(36,41,46);">Em <strong>publicConstraints&nbsp;=
</strong>est=C3=A3o configuradas as rotas que s=C3=A3o p=C3=BAblicas, ou se=
ja, n=C3=A3o exigem autentica=C3=A7=C3=A3o. No exemplo acima, uma chamda <e=
m>GET</em> no recurso <em>/health-check</em> n=C3=A3o exige autentica=C3=A7=
=C3=A3o.</span></p>
<h3 id=3D"Library-IAM-2.3.Configurandoasdepend=C3=AAnciasentrem=C3=B3dulos"=
>2.3. Configurando as depend=C3=AAncias entre m=C3=B3dulos</h3>
<p>As depend=C3=AAncias entre m=C3=B3dulos indicam quais s=C3=A3o as roles =
que o seu m=C3=B3dulo precisa ter nos outros m=C3=B3dulos para funcionar co=
rretamente a comunica=C3=A7=C3=A3o entre estes m=C3=B3dulos. Esta configura=
=C3=A7=C3=A3o =C3=A9 realizada atrav=C3=A9s do arquivo `security-permission=
s.yml`, sendo colocado dentro dos `resources`.&nbsp;=C3=89 poss=C3=ADvel de=
terminar 2 tipos de informa=C3=A7=C3=B5es, sendo `module` e `roles`. A segu=
ir =C3=A9 colocado um exemplo de configura=C3=A7=C3=A3o:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>security-permissions.yml</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">---
permissions:
&nbsp; - module: rw_iam
&nbsp; &nbsp; roles:
&nbsp; &nbsp; &nbsp; - iam_w
&nbsp; &nbsp; &nbsp; - iam_r
&nbsp; - module: rw_plmc
&nbsp; &nbsp; roles:
&nbsp; &nbsp; &nbsp; - plm_w
&nbsp; &nbsp; &nbsp; - plm_i_w
&nbsp; - module: rw_plmq
&nbsp; &nbsp; roles:
&nbsp; &nbsp; &nbsp; - plm_r</pre>=20
</div>
</div>
<p><br></p>
<p>Neste exemplo, em&nbsp;<strong>permissions</strong>, existem 5 roles, se=
ndo elas&nbsp;<strong>iam_w</strong>,&nbsp;<strong>iam_r</strong>,&nbsp;<st=
rong>plm_w</strong>,&nbsp;<strong>plm_r</strong>,&nbsp;<strong>plm_i_w</str=
ong>. Isto quer dizer que o seu m=C3=B3dulo ter=C3=A1 acesso as roles&nbsp;=
<strong>iam_w</strong> e&nbsp;<strong>iam_r</strong> do m=C3=B3dulo&nbsp;<s=
trong>rw_iam</strong>,&nbsp;<strong>plm_w</strong> e&nbsp;<strong>plm_i_w</=
strong> do m=C3=B3dulo&nbsp;<strong>rw_plmc</strong> e&nbsp;<strong>plm_r</=
strong> do m=C3=B3dulo&nbsp;<strong>rw_plmq</strong>.</p>
<h3 id=3D"Library-IAM-2.4.ConfigurandooFeign(Comunica=C3=A7=C3=A3oentreApli=
ca=C3=A7=C3=B5es)">2.4. Configurando o<span>&nbsp;</span><em>Feign</em><spa=
n>&nbsp;</span>(Comunica=C3=A7=C3=A3o entre Aplica=C3=A7=C3=B5es)</h3>
<p>Para facilitar a comunica=C3=A7=C3=A3o entre aplica=C3=A7=C3=B5es foi di=
sponibilizado um <em>interceptor</em>&nbsp;para o <em>Feign</em>. Desta for=
ma, a pr=C3=B3pria biblioteca trata de adicionar a autoriza=C3=A7=C3=A3o na=
s requisi=C3=A7=C3=B5es usando o <em>Feign</em>.</p>
<p>O primeiro passo a ser feito =C3=A9 a cria=C3=A7=C3=A3o de uma classe qu=
e implementa a interface <strong><em>RealmResolver</em></strong>. Esta clas=
se =C3=A9 respons=C3=A1vel por montar o <em>realm</em> que est=C3=A1 atrela=
da a requisi=C3=A7=C3=A3o. Normalmente, o <em>realm</em>&nbsp;corresponde a=
o nome da organiza=C3=A7=C3=A3o, que em geral =C3=A9 o valor recebido no He=
ader <em>X-Organization-Slug</em>. Contudo, algumas vezes estes par=C3=A2me=
tros podem vir de um banco de dados, um evento ou outra fonte de dados. Seg=
ue um exemplo de *Resolver* em Kotlin:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Resolver</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Compon=
ent
class Resolver: RealmResolver {
    override fun realm(): String =3D "zup"  =20
}</pre>=20
</div>
</div>
<p>O pr=C3=B3ximo passo consiste em realizar a instancia=C3=A7=C3=A3o do in=
terceptor chamado <em>IamFeignInterceptor</em>. De posse da inst=C3=A2ncia,=
 ela =C3=A9 passada para o builder do <em>Feign</em> no momento da cria=C3=
=A7=C3=A3o da inst=C3=A2ncia do servi=C3=A7o. A seguir =C3=A9 mostrado um e=
xemplo em <em>Kotlin</em>&nbsp;do uso do <em>Feign</em>&nbsp;junto da bibli=
oteca.</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Bean do Feign</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Autowi=
red
private lateinit var iamFeignInterceptor: IamFeignInterceptor

@Bean
open fun itemApi(): ItemApi =3D
    Feign.builder()
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.requestInterceptor(iamFeignInter=
ceptor) // Configura=C3=A7=C3=A3o do interceptor de IAM para o Feign.
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.target(ItemApi::class.java, "htt=
p://localhost:8080")</pre>=20
</div>
</div>
<p>Ao instanciar a <strong><em>IamFeignInterceptor</em></strong>&nbsp;=C3=
=A9 poss=C3=ADvel especificar o par=C3=A2metro <em>expirationThreshold</em>=
, sendo este respons=C3=A1vel por determinar quantos segundos antes da expi=
ra=C3=A7=C3=A3o s=C3=A3o necess=C3=A1rios para atualizar o token de autenti=
ca=C3=A7=C3=A3o. Por padr=C3=A3o o <em>expirationThreshold</em>&nbsp;=C3=A9=
 igual a 10. Por exemplo, se o tempo de expira=C3=A7=C3=A3o =C3=A9 igual a =
data 1504534891 e o <em>expirationThreshold</em>&nbsp;=C3=A9 igual a 10, ao=
 chegar no tempo 1504534881 a autoriza=C3=A7=C3=A3o =C3=A9 renovada. Este p=
rocedimento =C3=A9 realizado com o intuito de evitar erros devido a autoriz=
a=C3=A7=C3=B5es expiradas, uma vez que uma requisi=C3=A7=C3=A3o autorizada =
por ser realizada e no momento que o servi=C3=A7o receber a requisi=C3=A7=
=C3=A3o pode ter ocorrida a expira=C3=A7=C3=A3o da autoriza=C3=A7=C3=A3o.</=
p>
<p><strong><span style=3D"color: rgb(36,41,46);">2.4.1. Utilizando a lib Re=
alwave Feign Commons</span></strong></p>
<p>Com o intuito de tornar mais e pr=C3=A1tica a integra=C3=A7=C3=A3o entre=
 m=C3=B3dulos do Realwave, foi criada a lib spring-boot-starter-realwave-fe=
ign-commons:</p>
<p class=3D"auto-cursor-target">Adicione a lib ao projeto maven:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Depend=C3=AAncias Maven</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">&lt;depe=
ndency&gt;
    &lt;groupId&gt;br.com.zup.realwave&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-realwave-feign-commons&lt;/artifa=
ctId&gt;
    &lt;version&gt;last.version&lt;/version&gt;
&lt;/dependency&gt;</pre>=20
</div>
</div>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Bean do Feign</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Autowi=
red
private lateinit var feignConfigurer: FeignConfigurer

@Bean
open fun itemApi(): ItemApi =3D
    feignConfigurer.configure()
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.target(ItemApi::class.java, "htt=
p://localhost:8080")</pre>=20
</div>
</div>
<p><br></p>
<p>Este<span>&nbsp;</span><em>builder</em><span>&nbsp;</span>j=C3=A1 inclui=
:</p>
<ul>
<li><strong>JSON Content-Type Interceptor</strong>: Adiciona o header Conte=
nt-Type com valor<span>&nbsp;</span><em>application/json</em><span>&nbsp;</=
span>=C3=A0 requisi=C3=A7=C3=A3o.</li>
<li><strong>IAM Interceptor</strong>: Autentica no keycloak e adiciona o he=
ader Authorization =C3=A0 requisi=C3=A7=C3=A3o;</li>
<li><strong>Realwave Headers Interceptor</strong>: Adiciona os headers X-Or=
ganization-Slug, X-Application-Id, X-Api-Slug, X-ContextTracking-Id, X-Trac=
king-Id, X-Tracking-Source-Id, X-Channel-Id =C3=A0 requisi=C3=A7=C3=A3o, co=
m os valores obtidos do<span>&nbsp;</span><em>RealwaveContext</em>.</li>
<li><strong>JacksonEncoder</strong><span>&nbsp;</span>e<span>&nbsp;</span><=
strong>JacksonDecoder</strong>: Encoder e decoder j=C3=A1 configurados com =
o object-mapper do Realwave.</li>
</ul>
<p><br></p>
<p><span style=3D"color: rgb(36,41,46);">Caso n=C3=A3o haja necessidade de =
autentica=C3=A7=C3=A3o junto ao IAM:</span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Bean do Feign</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Autowi=
red
private lateinit var feignConfigurer: FeignConfigurer

@Bean
open fun itemApi(): ItemApi =3D
    feignConfigurer.configureWithoutAuth()
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.target(ItemApi::class.java, "htt=
p://localhost:8080")</pre>=20
</div>
</div>
<p><br></p>
<p><span style=3D"color: rgb(36,41,46);"><span style=3D"color: rgb(36,41,46=
);">Para utilizar o contrato padr=C3=A3o do Feign =C3=A9 necess=C3=A1rio ap=
enas chamar o m=C3=A9todo<span>&nbsp;</span></span><strong>feignDefaultCont=
ract()</strong><span style=3D"color: rgb(36,41,46);">, por exemplo:</span><=
/span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Bean do Feign</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Autowi=
red
private lateinit var feignConfigurer: FeignConfigurer

@Bean
open fun itemApi(): ItemApi =3D
    feignConfigurer.configure()
            .feignDefaultContract()
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.target(ItemApi::class.java, "htt=
p://localhost:8080")</pre>=20
</div>
</div>
<h3 id=3D"Library-IAM-2.5.Configurandoodiscoveryesincroniza=C3=A7=C3=A3o">2=
.5. Configurando o discovery e sincroniza=C3=A7=C3=A3o</h3>
<p>Para fazer o discovery e sincronizar as informa=C3=A7=C3=B5es do Keycloa=
k e dos dados do m=C3=B3dulo em si, foi criada a lib <em>zup-iam-adapters</=
em>.</p>
<p>Adiciona a lib ao projeto:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Lib do zup-iam-adapters</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: xml; gutter: false; theme: Confluence" data-theme=3D"Confluence">&lt;depe=
ndency&gt;
    &lt;groupId&gt;br.com.zup&lt;/groupId&gt;
    &lt;artifactId&gt;zup-iam-adapters&lt;/artifactId&gt;
    &lt;version&gt;last.version&lt;/version&gt;
&lt;/dependency&gt;</pre>=20
</div>
</div>
<p>Esta lib j=C3=A1 possui auto configura=C3=A7=C3=A3o, portanto, basta adi=
con=C3=A1-la.</p>
<h3 id=3D"Library-IAM-2.6.ObtendoInforma=C3=A7=C3=B5essobreaAutentica=C3=A7=
=C3=A3o">2.6. Obtendo Informa=C3=A7=C3=B5es sobre a Autentica=C3=A7=C3=A3o<=
/h3>
<p><span style=3D"color: rgb(36,41,46);text-decoration: none;">No contexto =
da autentica=C3=A7=C3=A3o, est=C3=A3o dispon=C3=ADveis algumas informa=C3=
=A7=C3=B5es sobre o usu=C3=A1rio autenticado. Estas informa=C3=A7=C3=B5es s=
=C3=A3o obtidas atrav=C3=A9s do token (JWT) e podem ser acessadas das segui=
ntes maneiras:</span></p>
<p><strong><span style=3D"color: rgb(36,41,46);text-decoration: none;">2.6.=
1. Modo Standard</span></strong></p>
<p><span style=3D"color: rgb(36,41,46);text-decoration: none;"><span style=
=3D"color: rgb(36,41,46);text-decoration: none;">Basta injetar o<span>&nbsp=
;</span></span><em style=3D"text-decoration: none;">Bean</em><span style=3D=
"color: rgb(36,41,46);text-decoration: none;"><span>&nbsp;</span></span><st=
rong style=3D"text-decoration: none;">AuthContext</strong><span style=3D"co=
lor: rgb(36,41,46);text-decoration: none;"><span>&nbsp;</span>que =C3=A9 cr=
iado pela auto-configura=C3=A7=C3=A3o da lib.</span></span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Resolver</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: java; gutter: false; theme: Confluence" data-theme=3D"Confluence">@Autowi=
red
private lateinit var authContext: AuthContext</pre>=20
</div>
</div>
<p><strong><span style=3D"color: rgb(36,41,46);text-decoration: none;">2.6.=
2. Modo Teste</span></strong></p>
<p><span style=3D"color: rgb(36,41,46);text-decoration: none;"><span style=
=3D"color: rgb(36,41,46);text-decoration: none;">No contexto de testes, par=
a gerar um mock do<span>&nbsp;</span></span><strong style=3D"text-decoratio=
n: none;">AuthContext</strong><span style=3D"color: rgb(36,41,46);text-deco=
ration: none;">, basta habilitar a propriedade no<span>&nbsp;</span></span>=
<em style=3D"text-decoration: none;">application.properties</em><span style=
=3D"color: rgb(36,41,46);text-decoration: none;">(ou<span>&nbsp;</span></sp=
an><em style=3D"text-decoration: none;">application.yml</em><span style=3D"=
color: rgb(36,41,46);text-decoration: none;">):</span></span></p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">security:
    mockContext:
        enabled: true</pre>=20
</div>
</div>
<p>Neste caso as seguintes propriedades ser=C3=A3o utilizadas:</p>
<ul style=3D"text-decoration: none;">
<li><strong>ID</strong>: "f7848248-ae03-11e7-abc4-cec278b6b50a"</li>
<li><strong>givenName</strong>: "Alan"</li>
<li><strong>familyName</strong>: "Turing"</li>
<li><strong>userName</strong>: "alan.turing"</li>
<li><strong>email</strong>: "<a style=3D"text-decoration: none;" href=3D"ma=
ilto:alan.turing@machine.com" class=3D"external-link" rel=3D"nofollow">alan=
.turing@machine.com</a>"</li>
<li><strong>externalId</strong>:&nbsp;"cb175572-27cb-4f03-92e1-155889bde0c6=
"</li>
<li><strong>externalType</strong>:&nbsp;"CUSTOMER"</li>
</ul>
<p>Caso haja necessidade de personalizar quaisquer das propriedades acima, =
basta incluir propriedades no<span>&nbsp;</span><em>application.properties<=
/em><span>&nbsp;</span>(ou<span>&nbsp;</span><em>application.yml</em>):</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">security:
    mockContext:
        enabled: true
        id: some-id
        givenName: Ludwig
        familyName: Beethoven
        userName: ludwig.beethoven
        email: ludwig.beethoven@music.com
        externalId: 8e2b77ea-72e7-4694-aea0-07b6617dd08d
        externalType: PROMOTER</pre>=20
</div>
</div>
<h3 id=3D"Library-IAM-2.7.ObtendoToken(Testes)">2.7. Obtendo Token (Testes)=
</h3>
<p>Para consumir um servi=C3=A7o protegido, deve-se enviar o header Authori=
zation com o seguinte formato:</p>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">Authoriza=
tion: Bearer &lt;token&gt;</pre>=20
</div>
</div>
<p class=3D"auto-cursor-target">Para obter o token como um usu=C3=A1rio:</p=
>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">POST &lt;=
url&gt;/auth/realms/zup/protocol/openid-connect/token

Content-Type: application/x-www-form-urlencoded

Form Params:

grant_type: password
client_id: realwave-iam-ui
username: &lt;username&gt;
password: &lt;password&gt;

</pre>=20
</div>
</div>
<p class=3D"auto-cursor-target">Para obter um token como um m=C3=B3dulo:</p=
>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: js; gutter: false; theme: Confluence" data-theme=3D"Confluence">POST &lt;=
url&gt;/auth/realms/zup/protocol/openid-connect/token

Content-Type: application/x-www-form-urlencoded

Form Params:

grant_type: client_credentials
client_id: &lt;rw_resource&gt;
client_secret: &lt;keycloak_secret&gt;

</pre>=20
</div>
</div>
<h2 class=3D"auto-cursor-target" id=3D"Library-IAM-3.Protegendoosendpointsa=
utoconfigurados">3. Protegendo os endpoints auto configurados</h2>
<h3 id=3D"Library-IAM-3.1.Protegendooendpointderevoga=C3=A7=C3=A3odetoken">=
3.1. Protegendo o endpoint de revoga=C3=A7=C3=A3o de token</h3>
<p>A partir da vers=C3=A3o&nbsp;<strong>2018R2.4.0</strong> das bibliotecas=
&nbsp;<strong>spring-boot-starter-zup-iam-feign</strong> e&nbsp;<strong>spr=
ing-boot-starter-realwave-feign-commons</strong>, um controlador =C3=A9 aut=
omaticamente adicionado ao seu projeto. Esta URL pode ser desativada atrav=
=C3=A9s da propriedade&nbsp;<strong>zup.iam.feign.revocation.enabled</stron=
g>, como vista na parte de configura=C3=A7=C3=A3o de biblioteca.</p>
<p>O endpoint adicionado pode ser acessado atrav=C3=A9s da URL&nbsp;<em><st=
rong>http://your_module_application:port/zup/iam/feign/auth</strong></em> u=
tilizando o verbo HTTP&nbsp;<em><strong>DELETE</strong></em>. A fun=C3=A7=
=C3=A3o deste endpoint =C3=A9 que, caso seja necess=C3=A1rio, seja poss=C3=
=ADvel limpar os tokens armazenados em mem=C3=B3ria, for=C3=A7ando assim o&=
nbsp;<em>interceptor</em><em> feign</em> a realizar o login novamente, simu=
lando assim o fim de uma sess=C3=A3o. Este cen=C3=A1rio pode ser utilizado =
caso seja necess=C3=A1rio uma interven=C3=A7=C3=A3o de urg=C3=AAncia no tok=
en que os m=C3=B3dulos est=C3=A3o utilizando e seja necess=C3=A1rio que ele=
s sejam reautenticados.</p>
<p>Para adicionar seguran=C3=A7a a este endpoint, siga o exemplo abaixo:</p=
>
<div class=3D"code panel pdl" style=3D"border-width: 1px;">
<div class=3D"codeHeader panelHeader pdl" style=3D"border-bottom-width: 1px=
;">
<b>Exemplo de configura=C3=A7=C3=A3o de rotas zup-iam-feign</b>
</div>
<div class=3D"codeContent panelContent pdl">=20
<pre class=3D"syntaxhighlighter-pre" data-syntaxhighlighter-params=3D"brush=
: py; gutter: true; theme: Confluence" data-theme=3D"Confluence">---
constraints:

    # Your applications constraints

  - pattern: /zup/iam/feign/auth
    roles:
      zup_admin:
        - DELETE</pre>=20
</div>
</div>
<p><br></p>
<h2 class=3D"auto-cursor-target" id=3D"Library-IAM-4.Errosconhecidos">4. Er=
ros conhecidos</h2>
<ul>
<li><strong>Factory method 'keycloakStub' threw exception; nested exception=
 is java.lang.NoClassDefFoundError: io/netty/handler/codec/Headers</strong>
<ul>
<li>Vers=C3=A3o do io.netty incompat=C3=ADvel; necess=C3=A1rio utilizar a v=
ers=C3=A3o 4.1 ou superior.</li>
</ul></li>
<li><strong>Factory method 'keycloakStub' threw exception; nested exception=
 is kotlin.KotlinNullPointerException</strong>
<ul>
<li>Arquivo application.properties est=C3=A1 faltando as propriedades do gR=
PC e da flag de sincroniza=C3=A7=C3=A3o (sync). Favor rever passo de config=
ura=C3=A7=C3=A3o da lib.</li>
</ul></li>
<li><strong>Error creating bean with name 'httpPutFormContentFilter'</stron=
g>
<ul>
<li>Vers=C3=A3o do Jackson deve ser 2.9 ou superior. Este erro =C3=A9 mais =
comum em projetos que utilizem Kotlin 1.2 ou superior.</li>
</ul></li>
</ul>
    </div>
</body>
</html>
------=_Part_68_534606306.1596570505320--
