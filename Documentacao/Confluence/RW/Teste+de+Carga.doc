Date: Tue, 4 Aug 2020 19:19:35 +0000 (UTC)
Message-ID: <2086844677.35.1596568775515@6f36c4f94bb4>
Subject: Exported From Confluence
MIME-Version: 1.0
Content-Type: multipart/related; 
	boundary="----=_Part_34_1612129038.1596568775514"

------=_Part_34_1612129038.1596568775514
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Content-Location: file:///C:/exported.html

<html xmlns:o=3D'urn:schemas-microsoft-com:office:office'
      xmlns:w=3D'urn:schemas-microsoft-com:office:word'
      xmlns:v=3D'urn:schemas-microsoft-com:vml'
      xmlns=3D'urn:w3-org-ns:HTML'>
<head>
    <meta http-equiv=3D"Content-Type" content=3D"text/html; charset=3Dutf-8=
">
    <title>Teste de Carga</title>
    <!--[if gte mso 9]>
    <xml>
        <o:OfficeDocumentSettings>
            <o:TargetScreenSize>1024x640</o:TargetScreenSize>
            <o:PixelsPerInch>72</o:PixelsPerInch>
            <o:AllowPNG/>
        </o:OfficeDocumentSettings>
        <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>90</w:Zoom>
            <w:DoNotOptimizeForBrowser/>
        </w:WordDocument>
    </xml>
    <![endif]-->
    <style>
                <!--
        @page Section1 {
            size: 8.5in 11.0in;
            margin: 1.0in;
            mso-header-margin: .5in;
            mso-footer-margin: .5in;
            mso-paper-source: 0;
        }

        table {
            border: solid 1px;
            border-collapse: collapse;
        }

        table td, table th {
            border: solid 1px;
            padding: 5px;
        }

        td {
            page-break-inside: avoid;
        }

        tr {
            page-break-after: avoid;
        }

        div.Section1 {
            page: Section1;
        }

        /* Confluence print stylesheet. Common to all themes for print medi=
a */
/* Full of !important until we improve batching for print CSS */

@media print {
    #main {
        padding-bottom: 1em !important; /* The default padding of 6em is to=
o much for printouts */
    }

    body {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        font-size: 10pt;
        line-height: 1.2;
    }

    body, #full-height-container, #main, #page, #content, .has-personal-sid=
ebar #content {
        background: #fff !important;
        color: #000 !important;
        border: 0 !important;
        width: 100% !important;
        height: auto !important;
        min-height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
    }

    a, a:link, a:visited, a:focus, a:hover, a:active {
        color: #000;
    }

    #content h1,
    #content h2,
    #content h3,
    #content h4,
    #content h5,
    #content h6 {
        font-family: Arial, Helvetica, FreeSans, sans-serif;
        page-break-after: avoid;
    }

    pre {
        font-family: Monaco, "Courier New", monospace;
    }

    #header,
    .aui-header-inner,
    #navigation,
    #sidebar,
    .sidebar,
    #personal-info-sidebar,
    .ia-fixed-sidebar,
    .page-actions,
    .navmenu,
    .ajs-menu-bar,
    .noprint,
    .inline-control-link,
    .inline-control-link a,
    a.show-labels-editor,
    .global-comment-actions,
    .comment-actions,
    .quick-comment-container,
    #addcomment {
        display: none !important;
    }

    /* CONF-28544 cannot print multiple pages in IE */
    #splitter-content {
        position: relative !important;
    }

    .comment .date::before {
        content: none !important; /* remove middot for print view */
    }

    h1.pagetitle img {
        height: auto;
        width: auto;
    }

    .print-only {
        display: block;
    }

    #footer {
        position: relative !important; /* CONF-17506 Place the footer at en=
d of the content */
        margin: 0;
        padding: 0;
        background: none;
        clear: both;
    }

    #poweredby {
        border-top: none;
        background: none;
    }

    #poweredby li.print-only {
        display: list-item;
        font-style: italic;
    }

    #poweredby li.noprint {
        display: none;
    }

    /* no width controls in print */
    .wiki-content .table-wrap,
    .wiki-content p,
    .panel .codeContent,
    .panel .codeContent pre,
    .image-wrap {
        overflow: visible !important;
    }

    /* TODO - should this work? */
    #children-section,
    #comments-section .comment,
    #comments-section .comment .comment-body,
    #comments-section .comment .comment-content,
    #comments-section .comment p {
        page-break-inside: avoid;
    }

    #page-children a {
        text-decoration: none;
    }

    /**
     hide twixies

     the specificity here is a hack because print styles
     are getting loaded before the base styles. */
    #comments-section.pageSection .section-header,
    #comments-section.pageSection .section-title,
    #children-section.pageSection .section-header,
    #children-section.pageSection .section-title,
    .children-show-hide {
        padding-left: 0;
        margin-left: 0;
    }

    .children-show-hide.icon {
        display: none;
    }

    /* personal sidebar */
    .has-personal-sidebar #content {
        margin-right: 0px;
    }

    .has-personal-sidebar #content .pageSection {
        margin-right: 0px;
    }

    .no-print, .no-print * {
        display: none !important;
    }
}
-->
    </style>
</head>
<body>
    <h1>Teste de Carga</h1>
    <div class=3D"Section1">
        <p>Foram realizados testes de stress no ambiente de QA afim de obte=
r m=C3=A9tricas de performance do m=C3=B3dulo "service" do Customer Manager=
 e tamb=C3=A9m verificar o funcionamento dos novos frameworks utilizados pe=
lo projeto. Para gera=C3=A7=C3=A3o da carga foi utilizada a ferramenta&nbsp=
;<strong><a class=3D"external-link" href=3D"http://jmeter.apache.org/" rel=
=3D"nofollow">Apache JMetter</a></strong>&nbsp;no ambiente de teste da ZUP =
(<a rel=3D"nofollow">zupme-qa-1a-performance001.aws.zup.com.br:5901</a>). E=
ste ambiente =C3=A9 composto por 6 m=C3=A1quina, sendo uma m=C3=A1quina a m=
aster e as demais os slaves. Apenas as slaves realizam as requisi=C3=A7=C3=
=B5es de acordo com os comandos da master.</p>
<p>Foram realizados testes de cria=C3=A7=C3=A3o e consulta de customers.</p=
>
<h2 id=3D"TestedeCarga-1.CapacidadedeEscrita(Cria=C3=A7=C3=A3odeCustomer)-T=
esteinicial">1. Capacidade de Escrita (Cria=C3=A7=C3=A3o de Customer) - Tes=
te inicial</h2>
<div class=3D"table-wrap">
<table class=3D"relative-table confluenceTable" style=3D"width: 57.5138%;">
<colgroup>
<col style=3D"width: 9.0411%;">
<col style=3D"width: 21.0959%;">
<col style=3D"width: 17.9452%;">
<col style=3D"width: 18.9041%;">
<col style=3D"width: 33.0137%;">
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de escrita (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=B0</td>
<td class=3D"confluenceTd">Qtd Threads Jmeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Resultado</td>
<td class=3D"confluenceTd">Throughput atingido</td>
</tr>
<tr>
<td colspan=3D"1" class=3D"confluenceTd">1</td>
<td colspan=3D"1" class=3D"confluenceTd">100</td>
<td colspan=3D"1" class=3D"confluenceTd">5 min</td>
<td colspan=3D"1" class=3D"confluenceTd">Lento</td>
<td colspan=3D"1" class=3D"confluenceTd">30 req/s</td>
</tr>
</tbody>
</table>
</div>
<p>Os testes iniciais foram muito ruins, bem abaixo do esperado, baseado ni=
sso, come=C3=A7amos a analisar tudo que a funcionalidade de criar customer =
fazia para tentar identificar se havia algo impactando nestes resultados. R=
esolvemos desconectar momentaneamente o <a href=3D"https://kafka.apache.org=
/" class=3D"external-link" rel=3D"nofollow">Apache Kafka</a> e o <a class=
=3D"external-link" href=3D"https://geteventstore.com/" rel=3D"nofollow">Eve=
nt Store</a>&nbsp;para analisar se algum destes componentes poderia ser o p=
roblema. Primeiro desconectamos o <a href=3D"https://kafka.apache.org/" cla=
ss=3D"external-link" rel=3D"nofollow">Apache Kafka</a>&nbsp;e o resultado f=
oi o mesmo, por=C3=A9m ao desconectar o&nbsp;<a class=3D"external-link" hre=
f=3D"https://geteventstore.com/" rel=3D"nofollow">Event Store</a>&nbsp;tive=
mos um aumento muito grande no throughput em rela=C3=A7=C3=A3o ao teste ini=
cial. Baseado nisso, come=C3=A7amos a analisar todo o c=C3=B3digo que reali=
zava algum tipo de intera=C3=A7=C3=A3o com o&nbsp;<a class=3D"external-link=
" href=3D"https://geteventstore.com/" rel=3D"nofollow">Event Store</a>&nbsp=
;e encontramos um bug na aplica=C3=A7=C3=A3o que cria=C3=A7=C3=A3o de um cu=
stomer completo, al=C3=A9m de registrar o evento de CustomerCreated estava =
registrando tamb=C3=A9m todos os eventos de seus agregados(Documentos, Cont=
atos e Endere=C3=A7os) sem necessidade, visto que estes j=C3=A1 est=C3=A3o =
embutidos no objeto do Customer no momento de sua cria=C3=A7=C3=A3o. Resolv=
emos o bug para registrar apenas o evento correto, conectamos novamente o&n=
bsp;<a class=3D"external-link" href=3D"https://geteventstore.com/" rel=3D"n=
ofollow">Event Store</a>&nbsp;na aplica=C3=A7=C3=A3o e fizemos uma nova bat=
eria de testes. Segue resultado abaixo:</p>
<h2 id=3D"TestedeCarga-2.CapacidadedeEscrita(Cria=C3=A7=C3=A3odeCustomer)-B=
ugcorrigido">2. Capacidade de Escrita (Cria=C3=A7=C3=A3o de Customer) - Bug=
 corrigido</h2>
<div class=3D"table-wrap">
<table class=3D"relative-table confluenceTable" style=3D"width: 57.5138%;">
<colgroup>
<col style=3D"width: 9.0411%;">
<col style=3D"width: 21.0959%;">
<col style=3D"width: 17.9452%;">
<col style=3D"width: 18.9041%;">
<col style=3D"width: 33.0137%;">
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de escrita (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=B0</td>
<td class=3D"confluenceTd">Qtd Threads Jmeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Resultado</td>
<td class=3D"confluenceTd">Throughput atingido</td>
</tr>
<tr>
<td colspan=3D"1" class=3D"confluenceTd">1</td>
<td colspan=3D"1" class=3D"confluenceTd">100</td>
<td colspan=3D"1" class=3D"confluenceTd">5 min</td>
<td colspan=3D"1" class=3D"confluenceTd">Lento</td>
<td colspan=3D"1" class=3D"confluenceTd">55 req/s</td>
</tr>
</tbody>
</table>
</div>
<p>Neste teste j=C3=A1 conseguimos ver uma grande melhoria em rela=C3=A7=C3=
=A3o ao teste anterior, por=C3=A9m o resultado ainda est=C3=A1 abaixo do es=
perado para este servi=C3=A7o. Ent=C3=A3o come=C3=A7amos a monitorar as req=
uisi=C3=A7=C3=B5es enviadas utilizando o <a href=3D"https://www.dynatrace.c=
om/" class=3D"external-link" rel=3D"nofollow">Dynatrace</a> para analisar d=
e forma mais detalhada o que estava consumindo mais recurso em cada requisi=
=C3=A7=C3=A3o. Identificamos que as requisi=C3=A7=C3=B5es estavam ficando m=
uito tempo aguardando conex=C3=B5es dispon=C3=ADveis do pool do <a href=3D"=
http://brettwooldridge.github.io/HikariCP/" class=3D"external-link" rel=3D"=
nofollow">Hikari</a>, ent=C3=A3o resolvemos aumentar a quantidade de conex=
=C3=B5es do pool de 20 para 40. Segue os resultados abaixo:</p>
<h2 id=3D"TestedeCarga-3.CapacidadedeEscrita(Cria=C3=A7=C3=A3odeCustomer)-P=
oolHikari40conex=C3=B5es">3. Capacidade de Escrita (Cria=C3=A7=C3=A3o de Cu=
stomer) - Pool Hikari 40 conex=C3=B5es</h2>
<div class=3D"table-wrap">
<table class=3D"relative-table confluenceTable" style=3D"width: 57.5138%;">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de escrita (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=B0</td>
<td class=3D"confluenceTd">Qtd Threads Jmeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Resultado</td>
<td class=3D"confluenceTd">Throughput atingido</td>
</tr>
<tr>
<td colspan=3D"1" class=3D"confluenceTd">1</td>
<td colspan=3D"1" class=3D"confluenceTd">100</td>
<td colspan=3D"1" class=3D"confluenceTd">5 min</td>
<td colspan=3D"1" class=3D"confluenceTd">M=C3=A9dio</td>
<td colspan=3D"1" class=3D"confluenceTd">65 req/s</td>
</tr>
</tbody>
</table>
</div>
<p>Assim como no teste anterior percebemos uma melhora no aumento do throug=
hput, mas ainda est=C3=A1 abaixo do esperado. Decidimos tentar realizar um =
teste mais simples, com uma rota que apenas busca algo, escolhemos a rota q=
ue retorna um customer por id. Fizemos uma nova bateria de testes nesta rot=
a e analisamos o resultado no&nbsp;<a href=3D"https://www.dynatrace.com/" c=
lass=3D"external-link" rel=3D"nofollow">Dynatrace</a>.&nbsp;Percebemos que =
para uma busca simples, a aplica=C3=A7=C3=A3o estava executando v=C3=A1rias=
 opera=C3=A7=C3=B5es com o <a href=3D"https://www.postgresql.org/" class=3D=
"external-link" rel=3D"nofollow">Postgree</a>, e ao analisar cada uma das o=
pera=C3=A7=C3=B5es, identificamos que eram relacionadas ao controle de <a h=
ref=3D"https://en.wikipedia.org/wiki/Multitenancy" class=3D"external-link" =
rel=3D"nofollow">Multi Tenant</a> da aplica=C3=A7=C3=A3o, este controle =C3=
=A9 feito atrav=C3=A9s de um interceptor que =C3=A9 executado em todas as r=
equisi=C3=A7=C3=B5es da aplica=C3=A7=C3=A3o, verificando se j=C3=A1 existe =
um schema no banco de dados referente ao&nbsp;<a href=3D"https://en.wikiped=
ia.org/wiki/Multitenancy" class=3D"external-link" rel=3D"nofollow">Multi Te=
nant</a>, e caso n=C3=A3o exista, =C3=A9 criado um novo. Por=C3=A9m, ap=C3=
=B3s a primeira requisi=C3=A7=C3=A3o, o <a href=3D"https://en.wikipedia.org=
/wiki/Multitenancy" class=3D"external-link" rel=3D"nofollow">Multi Tenant</=
a>&nbsp;sempre ir=C3=A1 existir para as requisi=C3=A7=C3=B5es subsequentes.=
 Ap=C3=B3s discutirmos com o time, conclu=C3=ADmos que est=C3=A1 n=C3=A3o =
=C3=A9 a melhor maneira de gerenciar os&nbsp;<a href=3D"https://en.wikipedi=
a.org/wiki/Multitenancy" class=3D"external-link" rel=3D"nofollow">Multi Ten=
ants</a> da aplica=C3=A7=C3=A3o e resolvemos remover este interceptor. Segu=
e abaixo o resultado:</p>
<h2 id=3D"TestedeCarga-4.CapacidadedeEscrita(Cria=C3=A7=C3=A3odeCustomer)-S=
eminterceptordeMultiTenant">4. Capacidade de Escrita (Cria=C3=A7=C3=A3o de =
Customer) - Sem interceptor de&nbsp;<a href=3D"https://en.wikipedia.org/wik=
i/Multitenancy" class=3D"external-link" rel=3D"nofollow">Multi Tenant</a></=
h2>
<div class=3D"table-wrap">
<table class=3D"relative-table confluenceTable" style=3D"width: 57.5138%;">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de escrita (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=B0</td>
<td class=3D"confluenceTd">Qtd Threads Jmeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Resultado</td>
<td class=3D"confluenceTd">Throughput atingido</td>
</tr>
<tr>
<td colspan=3D"1" class=3D"confluenceTd">1</td>
<td colspan=3D"1" class=3D"confluenceTd">100</td>
<td colspan=3D"1" class=3D"confluenceTd">5 min</td>
<td colspan=3D"1" class=3D"confluenceTd">M=C3=A9dio</td>
<td colspan=3D"1" class=3D"confluenceTd">75 req/s</td>
</tr>
</tbody>
</table>
</div>
<p>Mais uma vez conseguimos aumentar a quantidade de requisi=C3=A7=C3=B5es =
por segundo que a aplica=C3=A7=C3=A3o suporta, por=C3=A9m o n=C3=BAmero ain=
da n=C3=A3o =C3=A9 satisfat=C3=B3rio. Ap=C3=B3s revisar a arquitetura da ap=
lica=C3=A7=C3=A3o, vimos que a aplica=C3=A7=C3=A3o e o banco de dados est=
=C3=A3o em data centers diferentes. A aplica=C3=A7=C3=A3o est=C3=A1 na&nbsp=
;<a href=3D"http://azure.microsoft.com" class=3D"external-link" rel=3D"nofo=
llow">Microsoft Azure</a> e o banco relacional&nbsp;<a href=3D"https://www.=
postgresql.org/" class=3D"external-link" rel=3D"nofollow">PostgreSQL</a> es=
t=C3=A1 na&nbsp;<a href=3D"https://aws.amazon.com/pt/" class=3D"external-li=
nk" rel=3D"nofollow">Amazon AWS</a>, al=C3=A9m disso, tamb=C3=A9m existe um=
a VPN para acessar o banco de dados. Configuramos uma inst=C3=A2ncia do ban=
co de dados PostgreSQL no&nbsp;<a href=3D"http://azure.microsoft.com" class=
=3D"external-link" rel=3D"nofollow">Microsoft Azure</a>, este sem VPN, e re=
alizamos o teste novamente. Segue resultado:</p>
<h2 id=3D"TestedeCarga-5.CapacidadedeEscrita(Cria=C3=A7=C3=A3odeCustomer)-B=
ancodedadosPostgrenoAzure">5. Capacidade de Escrita (Cria=C3=A7=C3=A3o de C=
ustomer) - Banco de dados Postgre no Azure</h2>
<div class=3D"table-wrap">
<table class=3D"relative-table confluenceTable" style=3D"width: 57.5138%;">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de escrita (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=B0</td>
<td class=3D"confluenceTd">Qtd Threads Jmeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Resultado</td>
<td class=3D"confluenceTd">Throughput atingido</td>
</tr>
<tr>
<td colspan=3D"1" class=3D"confluenceTd">1</td>
<td colspan=3D"1" class=3D"confluenceTd">100</td>
<td colspan=3D"1" class=3D"confluenceTd">5 min</td>
<td colspan=3D"1" class=3D"confluenceTd">Bom</td>
<td colspan=3D"1" class=3D"confluenceTd">155 req/s</td>
</tr>
</tbody>
</table>
</div>
<p>Finalmente obtivemos um resultado satisfat=C3=B3rio. Com este resultado =
fica claro que a localidade do banco de dados est=C3=A1 impactando muito no=
 desempenho da aplica=C3=A7=C3=A3o, seja por estar em um data center difere=
nte ou por usar VPN.</p>
<h2 id=3D"TestedeCarga-6.CapacidadedeLeitura(ConsultadeCustomer)">6. Capaci=
dade de Leitura (Consulta de Customer)</h2>
<p>O resultado do teste abaixo j=C3=A1 =C3=A9 contemplando todas as melhori=
as realizadas nos testes anteriores de cria=C3=A7=C3=A3o de customer.</p>
<div class=3D"table-wrap">
<table class=3D"relative-table wrapped confluenceTable" style=3D"width: 57.=
3564%;">
<colgroup>
<col style=3D"width: 5.63187%;">
<col style=3D"width: 22.5275%;">
<col style=3D"width: 11.4011%;">
<col style=3D"width: 30.0824%;">
<col style=3D"width: 30.3571%;">
</colgroup>
<tbody>
<tr>
<td colspan=3D"5" class=3D"confluenceTd">Testes de capacidade de leitura (4=
 cores e 14 GB de Ram)</td>
</tr>
<tr>
<td class=3D"confluenceTd">N=C2=BA</td>
<td class=3D"confluenceTd">Qtd Threads JMeter</td>
<td class=3D"confluenceTd">Dura=C3=A7=C3=A3o</td>
<td class=3D"confluenceTd">Throughput atingido (AWS)</td>
<td class=3D"confluenceTd">Throughput atingido (Azure)</td>
</tr>
<tr>
<td class=3D"confluenceTd">1</td>
<td class=3D"confluenceTd">100</td>
<td class=3D"confluenceTd">5 Min</td>
<td class=3D"confluenceTd">110 req/s</td>
<td class=3D"confluenceTd">550 req/s</td>
</tr>
</tbody>
</table>
</div>
<p><br></p>
<h2 id=3D"TestedeCarga-Conclus=C3=A3oGeral">Conclus=C3=A3o Geral</h2>
<p>Foi muito importante a realiza=C3=A7=C3=A3o dos testes. Foi poss=C3=ADve=
l identificar bugs e melhorias na aplica=C3=A7=C3=A3o que precisavam ser fe=
itas para que a aplica=C3=A7=C3=A3o melhorasse seu desempenho.</p>
<p>=C3=89 importante ressaltar que mesmo concluindo que o banco de dados no=
 <a href=3D"https://aws.amazon.com/pt/" class=3D"external-link" rel=3D"nofo=
llow">Amazon AWS</a>&nbsp;est=C3=A1 impactando a aplica=C3=A7=C3=A3o, n=C3=
=A3o conseguimos migrar pois at=C3=A9 o momento de escrita deste documento =
(09/10/2017), o servi=C3=A7o equivalente ao do <a href=3D"https://aws.amazo=
n.com/pt/" class=3D"external-link" rel=3D"nofollow">Amazon AWS</a>&nbsp;que=
 existe no <a href=3D"http://azure.microsoft.com" class=3D"external-link" r=
el=3D"nofollow">Microsoft Azure</a>&nbsp;est=C3=A1 sendo disponibilizado ap=
enas em modo <a href=3D"https://azure.microsoft.com/en-gb/services/preview/=
" class=3D"external-link" rel=3D"nofollow">preview</a>.</p>
<p><br></p>
    </div>
</body>
</html>
------=_Part_34_1612129038.1596568775514--
